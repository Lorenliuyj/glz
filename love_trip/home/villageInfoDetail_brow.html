<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8">
		<title>贫困户详情</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link rel="stylesheet" href="../css/mui.min.css">
		<link href="../css/mui.picker.all.css" rel="stylesheet" />
		<link href="../css/viewImg.css" rel="stylesheet" />
		<style>
			html,body,.mui-content{background-color: white;}
			.mui-icon.mui-icon-plusempty{font-size: 17px;}
			.mui-icon-plusempty:before {content: '\e468';font-size: 530%;font-weight:bold;color: #12B6F6;}
			input::-webkit-input-placeholder{text-align: right;}
			input{font-size: 14px;color: #8f8f94;}
			!* .mui-table-view:before{height: 0px;}*!
			.mui-table-view:after{height: 0px;}
			.mui-table-view-chevron .mui-table-view-cell {padding-right: 20px;}
			.color-blue{color: #12B6F6 !important;}
			.myBtn{border: 1px solid #CCCCCC;width: 92px;height: 92px;text-align: center;color: #B8B8B8;font-weight: bold;display: inline-block;margin: 5px;}
            .mui-input-group:before{background-color: white;}
            mui-input-group:before{height: 0px;}
			.color-blue{color: #12B6F6 !important;}
			.btn-blue{background-color: #12B6F6;color: white;padding:6px 10px;border-radius: 6px;border: 0px;}
			.radio_inline{
				display: inline-block;
				width: 65%;
			}
			.radio_inline label{
				width: 20%;
				padding-left: 30px;
				padding-right: 30px;
				padding-top: 12px;
				font-size: 15px;
			}
			.radio_inline input[type=radio]{
				width: 15%;
				right: auto;
				padding-top: 2px;
			}
			input::-webkit-input-placeholder {
				text-align: right;
			}
			.mui-table-view.u:after{
				/*width: 96%;
				margin-left: 4%;*/
			}
		</style>
	</head>

	<body>
		<header class="mui-bar mui-bar-nav">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left color-blue"></a>
			<h1 class="mui-title color-blue">贫困户信息详情</h1>
			<a class="mui-pull-right color-blue" style="margin-top: 11px;font-size: 16px;" onclick="visitor();">走访录入</a>
		</header>
		<div class="mui-content mui-content-padded" style="margin-bottom:20px;">
			<form class="mui-input-group">
				<div class="mui-input-row">
					<label class="mui-pull-left" style="width: 40%;">姓名</label>
					<input id="povertyName" type="text" class="mui-input mui-pull-right"  style="width: 60%;"/>
				</div>
                <div class="mui-input-row">
                    <label style="width: 40%;">性别</label>
                    <div class="radio_inline mui-radio mui-pull-right" style="width: 60%;" >
                        <input name="sex" type="radio" value="0">
                        <label class="radio-inline"  style="width: 90px;">男</label>
                        <input name="sex" type="radio" value="1">
                        <label class="radio-inline"  style="width: 90px;">女</label>
                    </div>
                </div>
				<div class="mui-input-row">
					<label class="mui-pull-left" style="width: 40%;">身份证号</label>
					<input id="idcardNo" type="text" class="mui-input mui-pull-right" readonly="readonly" style="width: 60%;"/>
				</div>
				<ul class="mui-table-view mui-table-view-chevron u">
					<li class="mui-table-view-cell" id="timePicker">
						<label class="mui-pull-left" style="width: 40%;">出生年月</label>
						<p id="birthday" class="mui-pull-right">请选择</p>
					</li>
					<li class="mui-table-view-cell" id="forcountryPicker">
						<label class="mui-pull-left" style="width: 40%;">所属村居</label>
						<p id="village" class="mui-pull-right">请选择</p>
					</li>
					<li class="mui-table-view-cell" id="forhardPicker">
						<label class="mui-pull-left" style="width: 40%;">困难类型</label>
						<p id="povertyType" class="mui-pull-right">请选择</p>
					</li>
				</ul>
				<div class="mui-input-row">
					<label class="mui-pull-left" style="width: 40%;">住址</label>
					<input id="address" type="text" class="mui-input mui-pull-right" style="width: 60%;" placeholder="请输入住址"/>
				</div>
				<div class="mui-input-row">
					<label class="mui-pull-left" style="width: 40%;">联系电话</label>
					<input id="phone" type="text" class="mui-input mui-pull-right" style="width: 60%;" placeholder="请输入联系电话"/>
				</div>
				<div class="mui-input-row">
					<label class="mui-pull-left" style="width: 40%;">家庭情况</label>
					<input id="familyDetail" type="text" class="mui-input mui-pull-right" style="width: 60%;" placeholder="请输入家庭情况"/>
				</div>
				<div class="mui-input-row">
					<label class="mui-pull-left" style="width: 40%;">主要困难</label>
					<input id="trouble" type="text" class="mui-pull-right" style="width: 60%;" placeholder="请输入联系电话"/>
				</div>
				<p style="margin-left: 5px;">个人图片</p>
				<div class="mui-input-row" style="height: 100px;">
					<ul id="imgList" class="mui-table-view mui-grid-view">

					</ul>
				</div>
				<div class="mui-input-row" style="background-color: white;padding-bottom: 100px;display: none;">
					<form action="" method= "post" id="uploadForm">
						<div id="files" style="display: inline-block;margin: 5px 0px;float:left;"></div>
					</form>
					<a id="addBtn" class="myBtn mui-icon mui-icon-plusempty">
						<input id="addImageBtn" type="file" accept="image" onchange="selectFileImage(this)"  style="display:none;"/>
						<canvas id="myCanvas" style="display: none" ></canvas>
						<img src="" alt="" id="ago" style="display: none"/>
					</a>
				</div>
				<div class="mui-input-row">
					<p style="margin-left: 5px;">家庭月收入</p>
					<textarea id="income" type="textarea" rows="2" placeholder="请输入家庭月收入" class="mui-input-speech mui-input-clear"></textarea>
				</div>
				<div class="mui-input-row" style="margin-top: 10px;">
					<p style="margin-bottom: -2px;">备注</p>
					<textarea id="comments" type="textarea" rows="3" placeholder="请填写备注" class="mui-input-speech mui-input-clear"></textarea>
				</div>
			</form>
			<button id="submitBtn" class="mui-btn mui-btn-block btn-blue" style="margin-top: 5px;">保存</button>
		</div>
	</body>
	<script src="../js/mui.min.js"></script>
	<script src="../js/mui.picker.all.js"></script>
	<script src="../js/mobileBUGFix.mini.js"></script>
	<script src="../js/exif.js" ></script>
	<script src="../js/jquery2.min.js"></script>
	<script src="../js/mui.zoom.js"></script>
	<script src="../js/mui.previewimage.js"></script>
	<script src="../js/app.js"></script>
	<script src="../js/appajax.js"></script>
	
	<script type="text/javascript">
	mui.init();
	var id = localStorage.getItem("pid");
 	mui.ready(function() {
			mui.previewImage();
			forcountryPicker.setData(forcountryData);
			forhardPicker.setData(forhardData);
			
			var data = {id:id};
			var tabimg = gbid("imgList");
			console.log(data);
			appajax.SendRequestByPost("poverty/povertyInfo",JSON.stringify(data),function (response) {
				console.log(response.result);
				if("0000" == response.code) {
					var rtnData = response.result;
					$("#povertyName").val(rtnData.povertyName);
					$("[name='sex'][value='"+rtnData.sex+"']").prop("checked", "checked");
					$("#idcardNo").val(rtnData.idcardNo);
					$("#address").val(rtnData.address);
					$("#phone").val(rtnData.phone);
					$("#familyDetail").val(rtnData.familyDetail);
					$("#trouble").val(rtnData.trouble);
					$("#income").val(rtnData.income);
					$("#comments").val(rtnData.comments);
					$("#birthday").html(rtnData.birthday);
					birthday = rtnData.birthday;
					
					$("#village").html(getDictJsonText(forcountryData, rtnData.village));
					village = rtnData.village;
					$("#village").removeClass("mui-pull-right");
					
					$("#birthday").html(rtnData.birthday);
					$("#birthday").removeClass("mui-pull-right");
					
					$("#povertyType").html(rtnData.povertyType1+"-"+rtnData.povertyType2);
					$("#povertyType").removeClass("mui-pull-right");
					povertyType1 = rtnData.povertyType1;
					povertyType2 = rtnData.povertyType2;
				}
			},function(response) {
					mui.toast("查询详情失败！");
			},true);
			
			//同步查询图片
			appajax.SendRequestByPost("poverty/povertyInfoImgs",JSON.stringify(data),function (response) {
				console.log(response.result);
				var rtnData = response.result;
				if("0000" == response.code) {
					if(rtnData.image1!="") {
						var img = document.createElement('img');
						img.setAttribute("data-preview-src","");
						
						img.className = "mui-table-view-cell mui-col-sm-4 mui-col-xs-4";
						img.src = "data:image/png;base64,"+rtnData.image1;
						gbid("imgList").appendChild(img);
					}
					if(rtnData.image2!="") {
						var img = document.createElement('img');
						img.setAttribute("data-preview-src","");
						img.className = "mui-table-view-cell mui-col-sm-4 mui-col-xs-4";
						img.src = "data:image/png;base64,"+rtnData.image2;
						gbid("imgList").appendChild(img);
					}
					if(rtnData.image3!="") {
						var img = document.createElement('img');
						img.setAttribute("data-preview-src","");
						img.className = "mui-table-view-cell mui-col-sm-4 mui-col-xs-4";
						img.src = "data:image/png;base64,"+rtnData.image3;
						gbid("imgList").appendChild(img);
					}
				}
			},function(response) {
					mui.toast("查询图片失败！");
			},true);
			
			gbid('timePicker').addEventListener('tap', function(event) {
				timePicker.show(function(items) {
					birthday=parseDate(items.toString());
					if(items != null) {;
					   $("#birthday").addClass("mui-navigate-right");
						$("#birthday").removeClass("mui-pull-right");
					}
					gbid("birthday").innerHTML=items;
				});
			}); 
			gbid('forcountryPicker').addEventListener('tap', function(event) {
				forcountryPicker.show(function(items) {
					countryType=items[0].value;
					village=items[0].value;
					if(village == "") {
						$("#village").removeClass("mui-navigate-right");
						$("#village").addClass("mui-pull-right");
					}else {
						$("#village").addClass("mui-navigate-right");
						$("#village").removeClass("mui-pull-right");
					}
					gbid("village").innerHTML=items[0].text;
				});
			});
			gbid('forhardPicker').addEventListener('tap', function(event) {
				forhardPicker.show(function(items) {
					povertyType1 = items[0].value;
					povertyType2 = items[1].value;
					if(povertyType1 == "") {
						$("#povertyType").removeClass("mui-navigate-right");
						$("#povertyType").addClass("mui-pull-right");
						gbid("povertyType").innerHTML=items[0].text;
					}else {
						$("#povertyType").addClass("mui-navigate-right");
						$("#povertyType").removeClass("mui-pull-right");
						gbid("povertyType").innerHTML=items[0].text+"-"+items[1].text;
					}
				});
			});
		
			gbid('submitBtn').addEventListener('tap', function(event) {
				submitFun();
			});
		
	});

		
        //数据初始化
        var birthday = "";
        var village = "";
        var povertyType1 = "";
        var povertyType2 = ";"
        var timePicker = new mui.DtPicker({"type":"date","beginYear":new Date().getFullYear()-100,"endYear":new Date().getFullYear()});
        var forcountryPicker = new mui.PopPicker();
        var forhardPicker = new mui.PopPicker({layer: 2});
        var forcountryData=[{value:"",text:"请选择"},{value:"440784002",text:"东宁社区"},{value:"440784201",text:"古劳村"},
            {value:"440784202",text:"麦水村"},{value:"440784203",text:"丽水村"},{value:"440784204",text:"茶山村"},
            {value:"440784205",text:"下六村"},{value:"440784206",text:"连城村"},{value:"440784207",text:"连南村"},
            {value:"440784208",text:"连北村"},{value:"440784209",text:"大埠村"},{value:"440784210",text:"双桥村"},
            {value:"440784211",text:"上升村"},{value:"440784212",text:"新星村"}];
        var forhardData=[{value:"",text:"请选择",children:[{value:"",text:" "}]},
			{value:"001",text:"社事办",children:[{value:"00",text:"低保户"},{value:"01",text:"五保户"},{value:"02",text:"困难残疾人"}]},
			{value:"002",text:"组织办",children:[{value:"10",text:"困难党员"}]},
            {value:"003",text:"农业办",children:[{value:"20",text:"精准扶贫对象"}]},
			{value:"004",text:"镇妇办",children:[{value:"30",text:"单亲家庭"}]}];
		
		//提交方法
		function submitFun() {
			//校验
			var data = {id:id,birthday:birthday,
		        village:village,povertyType1:povertyType1,povertyType2:povertyType2,address:gbid('address').value,phone:gbid('phone').value,
		        familyDetail:gbid('familyDetail').value,trouble:gbid('trouble').value,income:$("#income").val(),comments:$("#comments").val()
			};
			if(!checkIsEmpty(data)) {
				return;
			}
		    appajax.SendRequestByPost("poverty/update",JSON.stringify(data),function (response) {
				if("0000" == response.code) {
					mui.toast("修改成功");
					setTimeout(function() {
						openUrl("villagelist_brow.html");
					},500);
				}else{
					mui.toast("修改失败！");
				}
		    },function(response) {
					mui.toast("修改失败！");
		    });
		}
		
		function checkIsEmpty(data) {
			if(data.birthday == "") {
				mui.toast("出生日期不能为空！");
				return false;
			}
			if(data.village == "") {
				mui.toast("所属村居不能为空！");
				return false;
			}
			if(data.difficultTypeId == "") {
				mui.toast("困难类型不能为空！");
				return false;
			}
			if(data.address == "") {
				mui.toast("住址不能为空！");
				return false;
			}
			if(data.phone == "") {
				mui.toast("联系电话不能为空！");
				return false;
			}
			if(!checkPhone(data.phone)) {
				mui.toast("联系方式有误，请重填!");
				return false;
			}
			return true;
		}
		
        var files=[];
        var fileName=null;
        var j=0;
        function upload(){
            fileName="";
            for(var i=0;i<files.length;i++){
                console.log("开始上传：");
                $.ajax({
                    url : server,
                    type : "POST",
                    data : files[i].value,
                    async: false,
                    cache: false,
                    contentType: false,
                    processData: false,
                    dataType: 'text',
                    success : function(data) {
                        var responseText = eval('('+data+')');
                        fileName += (fileName!="" ? "," : "") + responseText.url;
                        console.log(fileName);
                        j++;
                        if(j==files.length){
                            //
                        }
                        console.log("上传成功："+data);
                    },
                    error : function(data) {
                        console.log("上传失败："+data);
                    }
                });
            }
        }

        function selectFileImage(fileObj) {
            var file = fileObj.files['0'];
            var Orientation = null;
            if (file) {
                console.log("正在上传,请稍后...");
                var rFilter = /^(image\/jpeg|image\/png)$/i; // 检查图片格式
                if (!rFilter.test(file.type)) {
                    return;
                }
                //获取照片方向角属性，用户旋转控制
                EXIF.getData(file, function() {
                    EXIF.getAllTags(this);
                    Orientation = EXIF.getTag(this, 'Orientation');
                });
                var oReader = new FileReader();
                oReader.onload = function(e) {
                    //var blob = URL.createObjectURL(file);
                    //_compress(blob, file, basePath);
                    var image = new Image();
                    image.src = e.target.result;
                    image.onload = function() {
                        var expectWidth = this.naturalWidth;
                        var expectHeight = this.naturalHeight;

                        if (this.naturalWidth > this.naturalHeight && this.naturalWidth > 800) {
                            expectWidth = 800;
                            expectHeight = expectWidth * this.naturalHeight / this.naturalWidth;
                        } else if (this.naturalHeight > this.naturalWidth && this.naturalHeight > 1200) {
                            expectHeight = 1200;
                            expectWidth = expectHeight * this.naturalWidth / this.naturalHeight;
                        }

                        var canvas = document.createElement("canvas");
                        var ctx = canvas.getContext("2d");
                        canvas.width = expectWidth;
                        canvas.height = expectHeight;
                        ctx.drawImage(this, 0, 0, expectWidth, expectHeight);

                        var base64 = null;
                        var mpImg = new MegaPixImage(image);
                        mpImg.render(canvas, {
                            maxWidth: 800,
                            maxHeight: 1200,
                            quality: 0.8,
                            orientation: Orientation
                        });
                        base64 = canvas.toDataURL("image/png", 0.8);
                        appendFile(base64);
                    };
                };
                oReader.readAsDataURL(file);
            }
            fileObj.value = "";
        }

		//删除图片
		function removeFile(div,p){
			$("#addBtn").show();
			gbid("files").removeChild(div);
			index--;
			for (var i=0;i<files.length;i++) {
				if(files[i].path==p){
					files.splice(i,1);
					return;
				}
			}
		}

		function dataURLtoBlob(dataurl) {
			var arr = dataurl.split(','), mime = arr[0].match(/:(.*?);/)[1],
				bstr = atob(arr[1]), n = bstr.length, u8arr = new Uint8Array(n);
			while(n--){
				u8arr[n] = bstr.charCodeAt(n);
			}
			return new Blob([u8arr], {type:mime});
		}

		// 添加文件
		var index=1;
		var maxlength=3;
		function appendFile(p){
			var fe=document.getElementById("files");
			var div=document.createElement("div");
			var img=document.createElement("img");
			var btn=document.createElement("span");
			div.setAttribute("style","display: inline-block;");
			img.setAttribute("style","height: 90px;width: 90px;margin-left: 5px;");
			img.setAttribute("src",p);
			btn.setAttribute("class","mui-icon mui-icon-close-filled");
			btn.setAttribute("style","position: relative;bottom: 70px;right:25px;margin-right: -20px;");
			btn.onclick=function(){removeFile(div,"uploadkey"+index);};
			div.appendChild(img);
			div.appendChild(btn);
			fe.appendChild(div);
			var formData = new FormData();
			var blob = dataURLtoBlob(p);
			var file = new File([blob], new Date().getTime()+".png",{type:"image/png"});//创建新的文件对象用于上传
			formData.append("uploadkey"+index,file);
			files.push({key:"uploadkey"+index,value:formData});
			index++;
		}

		gbid('addBtn').addEventListener('tap', function(event) {
			if(index>maxlength){
				mui.toast("最多上传"+maxlength+"张图片");
				return;
			}
            $("#addImageBtn").click();
		});
		
		function visitor() {
			localStorage.setItem("povertyName",$("#povertyName").val());
			localStorage.setItem("birthday",birthday);
			localStorage.setItem("village",village);
			openUrl('visitor_brow.html');
		}

	</script>

</html>
